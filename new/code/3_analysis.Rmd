---
title: "Verification of Ooshima & Mitamura (2025) 'Effects of perspective-taking training based on relational frame theory for cognitive empathy and emotional empathy'"
subtitle: "Analysis"
author: "Ian Hussey"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
---

```{r, include=FALSE}
knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE)
```

# Dependencies

```{r}

library(tidyverse)
library(readxl)
library(broom)
library(janitor)
library(effectsize)
library(knitr)
library(kableExtra)

```

# Get data

```{r}

data_processed <- read_csv("../data/processed/data_processed.csv")

```

# Descriptives

```{r}

data_processed |>
  summarize(mean_pre_mes_perspective = mean(mes_perspective_pre),
            mean_post_mes_perspective = mean(mes_perspective_post),
            sd_pre_mes_perspective = sd(mes_perspective_pre),
            sd_post_mes_perspective = sd(mes_perspective_post),
            min_pre_mes_perspective = min(mes_perspective_pre),
            min_post_mes_perspective = min(mes_perspective_post),
            max_pre_mes_perspective = max(mes_perspective_pre),
            max_post_mes_perspective = max(mes_perspective_post)) |>
  pivot_longer(cols = everything()) |>
  kable() |>
  kable_classic(full_width = FALSE)

data_processed_exclusions <- data_processed |>
  mutate(mes_perspective_pre_exclusions = case_when(mes_perspective_pre < 13 ~ NA, # using the observed min/max scores from the other datasets
                                                    mes_perspective_pre > 22 ~ NA,
                                                    TRUE ~ mes_perspective_pre),
         mes_perspective_post_exclusions = case_when(mes_perspective_post < 13 ~ NA,
                                                    mes_perspective_post > 23 ~ NA,
                                                    TRUE ~ mes_perspective_post))

data_processed_exclusions |>
  drop_na(mes_perspective_pre_exclusions, mes_perspective_post_exclusions) |>
  count() |>
  kable() |>
  kable_classic(full_width = FALSE)

```

- dropping scores beyond the min max of the other datasets processed by the authors produces more drops than they had. so, manual comparison of my processed data and theirs seems necessary to see what differs.

# Pre-post comparisons

## Paired *t*-tests

All Students t-tests. The original study reported running Welches' t-tests for "Other-orientation, Affectedness, and Imagination subscales of the MES". 

```{r}

tidy_t <- function(data, pre, post, name, alternative = "two.sided"){
  t.test(pull(data, !!enquo(pre)),
         pull(data, !!enquo(post)),
         alternative = alternative,
         var.equal = TRUE) |>
    broom::tidy() |>
    mutate(outcome = name,
           hypothesis = alternative) |>
    select(outcome, hypothesis,
           mean_diff = estimate, t = statistic, df = parameter, p = p.value)
}

res_t <- bind_rows(
  tidy_t(data_processed, iri_pt_pre, iri_pt_post, "IRI PT", alternative = "greater"),
  tidy_t(data_processed, mes_perspective_pre, mes_perspective_post, "MES PT", alternative = "greater"),
  tidy_t(data_processed, tssq_perspective_pre, tssq_perspective_post, "TSSQ PT", alternative = "greater"),
  
  tidy_t(data_processed, iri_ec_pre, iri_ec_post, "IRI EC"),
  tidy_t(data_processed, iri_fs_pre, iri_fs_post, "IRI FS"),
  tidy_t(data_processed, iri_pd_pre, iri_pd_post, "IRI PD"),
  
  tidy_t(data_processed, mes_other_pre, mes_other_post, "MES other"),
  tidy_t(data_processed, mes_self_pre, mes_self_post, "MES self"),
  tidy_t(data_processed, mes_affected_pre, mes_affected_post, "MES affected"),
  tidy_t(data_processed, mes_imagination_pre, mes_imagination_post, "MES imagination"),
  
  tidy_t(data_processed, tssq_active_pre, tssq_active_post, "TSSQ active"),
  tidy_t(data_processed, tssq_conceptualization_pre, tssq_conceptualization_post, "TSSQ conceptualization"),
  tidy_t(data_processed, tssq_present_pre, tssq_present_post, "TSSQ present")
)

```

## Cohen's $d_{av}$

Note that I calculate Cohen's $d_{av}$ rather than approximating Cohen's $d_{s}$ from the *t*-statistic, as done in the original publication, as the former takes within subject variation into account to provide more precise estimates.

Because the original study estimates *d* from the *t* value, it can only find positive (absolute) values of Cohen's *d*. This can easily obscure the fact that some scales show (numerical) decreases in scores rather than increases.  

```{r}

tidy_d <- function(data, pre, post, name){
  repeated_measures_d(pull(data, !!enquo(pre)),
                      pull(data, !!enquo(post)),
                      paired = TRUE, 
                      method = "av") |>
    as_tibble() |>
    mutate(outcome = name) |>
    select(outcome, d = d_av, d_ci_lower = CI_low, d_ci_upper = CI_high)
}

res_d <- bind_rows(
  tidy_d(data_processed, iri_pt_pre, iri_pt_post, "IRI PT"),
  tidy_d(data_processed, mes_perspective_pre, mes_perspective_post, "MES PT"),
  tidy_d(data_processed, tssq_perspective_pre, tssq_perspective_post, "TSSQ PT"),
  
  tidy_d(data_processed, iri_ec_pre, iri_ec_post, "IRI EC"),
  tidy_d(data_processed, iri_fs_pre, iri_fs_post, "IRI FS"),
  tidy_d(data_processed, iri_pd_pre, iri_pd_post, "IRI PD"),

  tidy_d(data_processed, mes_other_pre, mes_other_post, "MES other"),
  tidy_d(data_processed, mes_self_pre, mes_self_post, "MES self"),
  tidy_d(data_processed, mes_affected_pre, mes_affected_post, "MES affected"),
  tidy_d(data_processed, mes_imagination_pre, mes_imagination_post, "MES imagination"),
  
  tidy_d(data_processed, tssq_active_pre, tssq_active_post, "TSSQ active"),
  tidy_d(data_processed, tssq_conceptualization_pre, tssq_conceptualization_post, "TSSQ conceptualization"),
  tidy_d(data_processed, tssq_present_pre, tssq_present_post, "TSSQ present")
) |>
  mutate(d_ci_width = d_ci_upper - d_ci_lower)

```

## Combined

```{r}

res_combined <- full_join(res_t, res_d, by = "outcome") |>
  mutate(Type = ifelse(outcome %in% c("IRI PT", "MES PT", "TSSQ PT"), "PT", "Not PT"))

ggplot(res_combined, aes(d, outcome, color = Type)) +
  geom_vline(xintercept = 0, linetype = "dotted") +
  ggstance::geom_linerangeh(aes(xmin = d_ci_lower, xmax = d_ci_upper)) +
  geom_point() +
  theme_linedraw() +
  scale_color_viridis_d(begin = 0.3, end = 0.7) +
  xlab("Cohen's d_av") +
  ylab("")

res_combined |>
  #arrange(outcome) |>
  mutate(mean_diff = round_half_up(mean_diff, 2),
         t = round_half_up(t, 2),
         p = round_half_up(p, 4),
         d = round_half_up(d, 2),
         d_ci_lower = round_half_up(d_ci_lower, 2),
         d_ci_upper = round_half_up(d_ci_upper, 2),
         d_ci_width = round_half_up(d_ci_width, 2)) |>
  kable() |>
  kable_classic(full_width = FALSE)

```

## Precision-weighted Cohen's $d_{av}$ across PT outcomes

This is basically a fixed-effects meta-analysis. Imperfect analysis given it ignores dependencies.

NB hypothesis predicts positive Cohen's *d* values.

### PT subscales

```{r}

res_es_weighted_pt <- res_d %>%
  filter(str_detect(outcome, " PT")) |>
  mutate(se = (d_ci_upper - d_ci_lower) / (2 * 1.96),
         weight = 1 / (se^2)) |>
  summarize(weighted_d = sum(d * weight) / sum(weight),
            se_weighted_d = sqrt(1 / sum(weight))) |>
  mutate(ci_lower = weighted_d - 1.96 * se_weighted_d,
         ci_upper = weighted_d + 1.96 * se_weighted_d) |>
  select(weighted_d, ci_lower, ci_upper)

res_es_weighted_pt |>
  mutate_if(is.numeric, round_half_up, digits = 2) |>
  kable() |>
  kable_classic(full_width = FALSE)

```

### Non PT subscales

```{r}

res_es_weighted_nonpt <- res_d %>%
  filter(!str_detect(outcome, " PT")) |>
  mutate(se = (d_ci_upper - d_ci_lower) / (2 * 1.96),
         weight = 1 / (se^2)) |>
  summarize(weighted_d = sum(d * weight) / sum(weight),
            se_weighted_d = sqrt(1 / sum(weight))) |>
  mutate(ci_lower = weighted_d - 1.96 * se_weighted_d,
         ci_upper = weighted_d + 1.96 * se_weighted_d) |>
  select(weighted_d, ci_lower, ci_upper)

res_es_weighted_nonpt |>
  mutate_if(is.numeric, round_half_up, digits = 3) |>
  kable() |>
  kable_classic(full_width = FALSE)

```

- Significant positive effect - counter the prediction of the theory. 





